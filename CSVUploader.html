<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>CSV íŒŒì¼ ì—…ë¡œë“œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 50px 20px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      background: #eef0ff;
      border-color: #764ba2;
    }

    .upload-area.dragover {
      background: #e0e7ff;
      border-color: #4f46e5;
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }

    .upload-text {
      color: #667eea;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .upload-hint {
      color: #999;
      font-size: 14px;
    }

    #fileInput {
      display: none;
    }

    .file-info {
      background: #f0f4ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .file-info.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .file-details {
      color: #666;
      font-size: 13px;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
    }

    #uploadBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #uploadBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    #uploadBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #cancelBtn {
      background: #f3f4f6;
      color: #666;
    }

    #cancelBtn:hover {
      background: #e5e7eb;
    }

    .progress-container {
      display: none;
      margin-top: 20px;
    }

    .progress-container.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-text {
      text-align: center;
      color: #666;
      font-size: 14px;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      display: none;
    }

    .status.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .status.success {
      background: #d1fae5;
      color: #065f46;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .format-info {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      font-size: 13px;
      color: #666;
    }

    .format-info strong {
      display: block;
      color: #333;
      margin-bottom: 8px;
    }

    .format-info ul {
      margin-left: 20px;
      margin-top: 5px;
    }

    .format-info li {
      margin: 3px 0;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>ğŸ“¤ CSV íŒŒì¼ ì—…ë¡œë“œ</h1>
    <div class="subtitle">ì€í–‰/ì¹´ë“œ ê±°ë˜ë‚´ì—­ ë˜ëŠ” ì„¸ê¸ˆê³„ì‚°ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>

    <!-- ì—…ë¡œë“œ ìœ í˜• ì„ íƒ -->
    <div style="margin-bottom: 20px; text-align: center;">
      <label style="margin-right: 15px;">
        <input type="radio" name="uploadType" value="bank" checked> ğŸ¦ ì€í–‰/ì¹´ë“œ ê±°ë˜ë‚´ì—­
      </label>
      <label style="margin-right: 15px;">
        <input type="radio" name="uploadType" value="tax"> ğŸ§¾ ì„¸ê¸ˆê³„ì‚°ì„œ (í™ˆíƒìŠ¤)
      </label>
      <label>
        <input type="radio" name="uploadType" value="tax_bank"> ğŸ¦ ì„¸ê¸ˆê³„ì‚°ì„œìš© ì€í–‰ë‚´ì—­ (ì—°ê°„ ëŒ€ì¡°ìš©)
      </label>
    </div>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
      <div class="upload-hint">ì§€ì› í˜•ì‹: .csv (UTF-8 ê¶Œì¥)</div>
    </div>

    <input type="file" id="fileInput" accept=".csv,text/csv">

    <div class="file-info" id="fileInfo">
      <div class="file-name" id="fileName">íŒŒì¼ëª….csv</div>
      <div class="file-details" id="fileDetails">í¬ê¸°: 0 KB | í–‰: 0ê°œ</div>
    </div>

    <div class="button-group">
      <button id="uploadBtn" disabled>ì—…ë¡œë“œ ë° ìë™ì²˜ë¦¬</button>
      <button id="cancelBtn">ì·¨ì†Œ</button>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘...</div>
    </div>

    <div class="status" id="status"></div>

    <div class="format-info">
      <strong>ğŸ“‹ CSV íŒŒì¼ í˜•ì‹:</strong>
      <ul>
        <li>ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì…ë‹ˆë‹¤</li>
        <li>í•„ìˆ˜ ì—´: ì¼ì, ì¹´ë“œ/ê³„ì¢Œ, ê±°ë˜ì²˜, ì¶œê¸ˆì•¡, ì…ê¸ˆì•¡</li>
        <li>ì„ íƒ ì—´: ë©”ëª¨</li>
        <li>ì¸ì½”ë”©: UTF-8 ê¶Œì¥</li>
      </ul>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileDetails = document.getElementById('fileDetails');
    const uploadBtn = document.getElementById('uploadBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const status = document.getElementById('status');

    let selectedFile = null;
    let parsedData = null;

    // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    // íŒŒì¼ ì„ íƒ
    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });

    // íŒŒì¼ ì²˜ë¦¬
    function handleFile(file) {
      if (!file) return;

      if (!file.name.endsWith('.csv')) {
        showStatus('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤!', 'error');
        return;
      }

      selectedFile = file;
      fileName.textContent = file.name;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        parsedData = parseCSV(text);

        const sizeKB = (file.size / 1024).toFixed(2);
        fileDetails.textContent = `í¬ê¸°: ${sizeKB} KB | í–‰: ${parsedData.length - 1}ê°œ (í—¤ë” ì œì™¸)`;

        fileInfo.classList.add('show');
        uploadBtn.disabled = false;
        hideStatus();
      };
      reader.readAsText(file, 'UTF-8');
    }

    // CSV íŒŒì‹±
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const result = [];

      for (let line of lines) {
        // ê°„ë‹¨í•œ CSV íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„, ë”°ì˜´í‘œ ì²˜ë¦¬)
        const row = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        row.push(current.trim());
        result.push(row);
      }

      return result;
    }

    // ì—…ë¡œë“œ ë²„íŠ¼
    uploadBtn.addEventListener('click', () => {
      if (!parsedData) return;

      uploadBtn.disabled = true;
      cancelBtn.disabled = true;
      progressContainer.classList.add('show');

      setProgress(10, 'CSV ë°ì´í„° ì „ì†¡ ì¤‘...');

      const uploadType = document.querySelector('input[name="uploadType"]:checked').value;

      // Google Apps Script ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onError)
        .processUploadedCSV(parsedData, uploadType);
    });

    // ì·¨ì†Œ ë²„íŠ¼
    cancelBtn.addEventListener('click', () => {
      google.script.host.close();
    });


    // ì—ëŸ¬ í•¸ë“¤ëŸ¬
    function onError(error) {
      showStatus(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
      uploadBtn.disabled = false;
      cancelBtn.disabled = false;
      progressContainer.classList.remove('show');
    }

    // ì§„í–‰ë¥  í‘œì‹œ
    function setProgress(percent, text) {
      progressFill.style.width = percent + '%';
      progressText.textContent = text;
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(message, type) {
      status.textContent = message;
      status.className = 'status show ' + type;
    }

    function hideStatus() {
      status.classList.remove('show');
    }
  </script>
</body>

</html>